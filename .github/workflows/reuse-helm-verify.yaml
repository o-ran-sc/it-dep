---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2023 The Linux Foundation, 2025 OpenInfra Foundation Europe

name: "[R] Helm Verify"

# yamllint disable-line rule:truthy
on:
  workflow_call:
    inputs:
      # Mandatory Gerrit inputs
      GERRIT_PROJECT:
        description: "Project in Gerrit"
        required: true
        type: string
      GERRIT_REFSPEC:
        description: "Gerrit refspec of change"
        required: true
        type: string
      CHARTS_BUILD_DIR:
        description: "Directory where built charts are stored"
        required: true
        type: string
      CHART_ARTIFACT_NAME:
        description: "Name of the chart artifact"
        required: true
        type: string
      HELM_VERSION:
        description: "Version of Helm to use"
        required: true
        type: string
      CHARTMUSEUM_STORAGE_DIR:
        description: "Directory where ChartMuseum stores its files"
        required: true
        type: string
      RIC_DEP_CI_DOCKER_FILE:
        description: "Path to the Dockerfile for the RIC_AUX and RIC_DEP"
        required: true
        type: string

    outputs:
      charts_build_dir: 
        description: "Directory where built charts are stored"
        value: "${{ inputs.CHARTS_BUILD_DIR }}"
      chart_artifact_name:
        description: "Name of the chart artifact"
        value: "${{ inputs.CHART_ARTIFACT_NAME }}"


jobs:
  verify:
    name: 'Build/Verify Helm Charts'
    runs-on: 'ubuntu-latest'
    outputs:
      charts_build_dir: "${{ inputs.CHARTS_BUILD_DIR }}"
      chart_artifact_name: "${{ inputs.CHART_ARTIFACT_NAME }}"
    timeout-minutes: 15
    steps:
      - name: 'Display workflow environment'
        shell: bash
        run: |
            # Display workflow environment
            echo "RIC_DEP_CI_DOCKER_FILE: $RIC_DEP_CI_DOCKER_FILE"
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
      - name: 'Setup Helm'
        # yamllint disable-line rule:line-length
        uses: azure/setup-helm@b9e51907a09c216f16ebe8536097933489208112  # v4.3.0

      - name: 'Set up Docker Buildx'
        # yamllint disable-line rule:line-length
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435  # v3.11.1

      - name: 'Build pre-requisites, install Helm plugins'
        id: pre-requisites
        shell: bash
        run: |
          # Build pre-requisites
          echo 'Running: git submodule update --init ðŸ’¬'
          git submodule update --init
          echo 'Running: helm plugin installs ðŸ’¬'
            plugin_dir='smo-install/onap_oom/kubernetes/helm/plugins/'
          helm plugin install "$plugin_dir/undeploy/"
          helm plugin install "$plugin_dir/deploy/"
          # Installation of helm-push fixes the error below
          # Error: unknown command "cm-push" for "helm"
          # yamllint disable-line rule:line-length
          helm plugin install https://github.com/chartmuseum/helm-push
          echo 'Listing Helm plugins ðŸ’¬'
          helm plugin list

      - name: 'Start ChartMuseum'
        id: chartmuseum
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/chartmuseum-action@4fb530a2cc2b2b46c0ea48ba11445c01247aba2a # v0.1.2
        with:
          username: 'chartmuseum'
          password: "${{ secrets.GITHUB_TOKEN }}"
          exit: false
          directory: "${{ inputs.CHARTMUSEUM_STORAGE_DIR }}"
          helm_repo_name: 'local'

      # Makefiles publish to Chartmeusem service locally
      - name: 'Build onap_oom'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/make-action@361e48884a6b7d7b5fcfcb38f399aa14e45127dc  # v0.1.1
        with:
          make_args: "-C smo-install/onap_oom/kubernetes -e SKIP_LINT=TRUE"

      # Makefiles publish to Chartmeusem service locally
      - name: 'Build oran_oom'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/make-action@361e48884a6b7d7b5fcfcb38f399aa14e45127dc  # v0.1.1
        with:
          make_args: "-C smo-install/oran_oom"

      # Makefiles publish to Chartmeusem service locally
      - name: 'Build oran_oom/smo'
        # yamllint disable-line rule:line-length
        uses: lfreleng-actions/make-action@361e48884a6b7d7b5fcfcb38f399aa14e45127dc  # v0.1.1
        with:
          make_args: "-C smo-install/oran_oom/smo"

      - name: Build ric-aux and ric-dep
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ${{ inputs.RIC_DEP_CI_DOCKER_FILE }}
          push: false
          tags: ""
